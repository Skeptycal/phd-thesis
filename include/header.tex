\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

% modify the default page geometry
\usepackage[left=1.7in,right=1.5in,top=2cm,bottom=2cm,includefoot,includehead,headheight=13.6pt]{geometry}

% =============================================================================
\usepackage{algorithm}
\usepackage{alltt} % math support in verbatim text
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bold-extra} % bold support for small caps 
\usepackage[hypcap]{caption} % with hyperref point to the head of the pic
\usepackage{caption}
\usepackage{chngpage} % allows for temporary adjustment of side margins
\usepackage{cite}
\usepackage{color} % custom colors for text
\usepackage{enumerate} % enable enumerated lists
\usepackage{enumitem} % enables [noitemsep,nolistsep] for more compact lists
\usepackage{booktabs} % used for \midrule
\usepackage{fancyhdr} % Fancy Header and Footer
\usepackage{float}      % for the strong here [H] of figures
\usepackage{graphicx} % extended arguments for \in­clude­graph­ics
\usepackage[htt]{hyphenat} % enable hyphenation of \textt + custom hypenation rules for words
% \usepackage{hyperref} see at the end of the header.tex
\usepackage{ifthen} % support boolean "branches" => enables conditional macros
\usepackage{tgtermes} % tex gyre thermes font
\usepackage{multirow} % fancy stuff for tables: multirow, bigdelim, bigstrut
\usepackage{rotating} % Sideways of figures & tables
\usepackage{slantsc} % http://ctan.org/pkg/slantsc enable fake italic small caps in fonts that do not have native support for this
\usepackage{stmaryrd} % St Mary Road symbols for theoretical computer science
\usepackage{subcaption}
\usepackage{url}    % add url/link support    
\usepackage{xspace}
\usepackage[normalem]{ulem} % for \sout
\usepackage{xcolor}
\usepackage{tablefootnote}
\usepackage{pifont} %  Access to PostScript standard Symbol and Dingbats fonts

% Font choices (I need real smallcaps!)
%\usepackage{libertine}
%\usepackage[osf]{mathpazo} % palatino with real small caps and oldstyle numbers
\usepackage{tgpagella} % Use TeX Gyre Pagella with real small caps (normal + bold)
\usepackage{tgcursor} % fixed wifth font TeX Gyre Cursor (Courrier Style)

% =============================================================================
% enable decimal columns in tables
\usepackage{dcolumn}
% define a new columntype "d" for decimal aligned numbers which takes as argument
% the number of decimal places to be displayed
\newcolumntype{d}[1]{D{.}{.}{#1} }

%the argument for d specifies the maximum number of decimal places
%\begin{tabular}{l r c d{1} }
%Left&Right&Center&\mathrm{Decimal}\\
%1&2&3&4\\
%11&22&33&44\\
%1.1&2.2&3.3&4.4\\
%\end{tabular}
% =============================================================================
% support proper SI units in latex: for instance \num{0.235+-0.005} is properly formatted as 0.235(5)
\usepackage{siunitx} 
% setup the si units package globally
\sisetup{
%	separate-uncertainty = true % show the +/- for uncertainty, computer scienticts have no clue about the 0.2352(66) notion
}


% =============================================================================
 % environment hooks and patching:
\usepackage{etoolbox}

\makeatletter
% uncomment the following if you don't want \clubpenalty\@M ...
% \let\nearly@afterheading\@afterheading
% \patchcmd\nearly@afterheading
%   {\@M}% original temporary setting for \clubpenalty replaced by ...
%   {\@clubpenalty}% ... or whichever value you deem right
%   {}{}
% ... and use \nearly@afterheading instead of \@afterheading here:
\newcommand*\NoIndentAfterEnv[1]{%
  \AfterEndEnvironment{#1}{\par\@afterindentfalse\@afterheading}}
\makeatother

% Disable indentation after a certain environment: \NoIndentAfterEnv{itemize}
% note that this might break the space for the following paragraph
%\NoIndentAfterEnv{itemize}
%\NoIndentAfterEnv{enumerate}
%\NoIndentAfterEnv{description}
%\NoIndentAfterEnv{table}
%\NoIndentAfterEnv{figure}

%\renewcommand*\arraystretch{1.2} % modify the line spacing in tables

% globally reduce the space between list items
\newlength{\wideitemsep}
\setlength{\wideitemsep}{.5\itemsep}
\addtolength{\wideitemsep}{-3pt}
\let\olditem\item
\renewcommand{\item}{\setlength{\itemsep}{\wideitemsep}\olditem}


% =============================================================================
% Table of contents for each chapter
\usepackage[nottoc, notlof, notlot]{tocbibind}
\usepackage[tight]{minitoc} % tight=single line spacing
\setcounter{minitocdepth}{1}
% change the minitoc fonts
\renewcommand{\mtcfont}{\small\normalfont} 
\renewcommand{\mtcSfont}{\mtcfont} 
\renewcommand{\mtifont}{\Large\bf} % use the same font as for the section font for the title of the contents
\nomtcrule % no minito rule
\mtcindent=2pt % indent just enough to make it visually look aligned

\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{2}
  
% =============================================================================
% Fancy Header Style Options

\pagestyle{fancy}                       % Sets fancy header and footer
\fancyfoot{}                            % Delete current footer settings

%\renewcommand{\chaptermark}[1]{         % Lower Case Chapter marker style
%  \markboth{\chaptername\ \thechapter.\ #1}}{}} %

%\renewcommand{\sectionmark}[1]{         % Lower case Section marker style
%  \markright{\thesection.\ #1}}         %

\fancyhead[LE,RO]{\thepage}    % Page number (boldface) on left on even
% pages and right on odd pages
\fancyhead[RE]{\nouppercase{\leftmark}}      % Chapter on the right on even pages
\fancyhead[LO]{\nouppercase{\rightmark}}     % Section on the left on odd pages

\let\headruleORIG\headrule
\renewcommand{\headrule}{\color{black} \headruleORIG}
\renewcommand{\headrulewidth}{0.5pt}
\usepackage{colortbl}
\arrayrulecolor{black}

\fancypagestyle{plain}{
  \fancyhead{}
  \fancyfoot{}
  \renewcommand{\headrulewidth}{0pt}
}

% Clear Header Style on the Last Empty Odd pages
\makeatletter

\def\cleardoublepage{\clearpage\if@twoside \ifodd\c@page\else%
  \hbox{}%
  \thispagestyle{empty}%              % Empty header styles
  \newpage%
  \if@twocolumn\hbox{}\newpage\fi\fi\fi}

\makeatother

% centered page environment
\newenvironment{vcenterpage}
	{\newpage\vspace*{\fill}\thispagestyle{empty}\renewcommand{\headrulewidth}{0pt}}
	{\vspace*{\fill}}
	
% automatically insert a period at the end of a paragraph title.
\let\originalparagraph\paragraph
\renewcommand{\paragraph}[2][.]{\originalparagraph{#2#1\!\!\!\!}}

% enable french spacing: 1 space after a dot instead of the 2 in english
\frenchspacing

%=============================================================================
\usepackage{needspace}
% \needlines{3} ensures that the followin 3 lines will be on the same page
\newcommand{\needlines}[1]{\Needspace{#1\baselineskip}}

\usepackage{xcolor}
\definecolor{source}{gray}{0.95}
% source code formatting
\usepackage{listings}
% global settings for source code listing package
\lstset{
    basicstyle=\ttfamily,
    showspaces=false,
    showstringspaces=false,
    lineskip=-0.1pt,
    stepnumber=2,
    numberfirstline=true,
    captionpos=b,
    emphstyle=\bf\ttfamily,
    columns=fullflexible}

\lstdefinelanguage{ST}{
    keywordsprefix=\#,
    morekeywords=[0]{true,false,nil},
    morekeywords=[1]{self,super,thisContext},
    morekeywords=[2]{ifTrue:,ifFalse:,whileTrue:,whileFalse:,and:,or:,xor:,not:,by:,timesRepeat:},
	morekeywords=[3]{Benzo,FFI},
    sensitive=true,
    morecomment=[s]{"}{"},
    morestring=[d]',
    escapechar={!},
    alsoletter={., :, -, =, +, <},
    moredelim=**[is][\itshape]{/+}{+/},
    literate=
        {^}{{$\uparrow$}}1
        {:=}{{$\leftarrow$}}1
        {~}{{$\sim$}}1
        {-}{{\sf -\hspace{-0.13em}-}}1  % the goal is to make - the same width as +
        {+}{\raisebox{0.08ex}{+}}1		% and to raise + off the baseline to match V
        , % Don't forget the comma at the end!
    style=STStyle
}
\lstdefinestyle{STStyle}{
    tabsize=4,
    %frame=leftline,
    %frame=bl,
    %framerule=2pt,
    %rulecolor=\color{gray},
    %backgroundcolor=\color{white},
    %backgroundcolor=\usebeamercolor[bg]{listing},
    basicstyle=\ttfamily,
    keywordstyle=\bfseries\ttfamily,
    %stringstyle=\color{orange},
    stringstyle=\mdseries\slshape,
    %commentstyle=\it\rmfamily\color{darkgray}, 
    commentstyle=\mdseries\slshape\color{darkgray},
    %commentstyle=\mdseries\slshape,
    emphstyle=\bf\ttfamily,
    escapeinside={!}{!},
	%backgroundcolor=\color{source},
    %emphstyle={[2]\color{red}},
    %emphstyle={[3]\color{blue}\bf},
    %emphstyle={[4]\color{blue}},
    keepspaces=true
} 

%\lstnewenvironment{javacode}  [1][]{\lstset{language=java,#1}\needlines{#2}}{} 
%\lstnewenvironment{pythoncode}[2][]{\lstset{language=python,#1}\needlines{#2}}{}
\lstnewenvironment{stcode}    [2][]{\lstset{language=ST,#1}\needlines{#2}}{}
\lstnewenvironment{ccode}     [2][]
    {\lstset{language=C,numbers=left,escapechar=\$,numberstyle=\tiny,#1}\needlines{#2}}{}

% code environment with line numbers
\lstnewenvironment{numstcode} [2][]
    {\lstset{language=ST,numbers=left,numberstyle=\tiny,numbersep=5pt,#1}\needlines{#2}}{}
\lstnewenvironment{numstcodecont} [2][]
    {\lstset{language=ST,numbers=left,numberstyle=\tiny,numbersep=5pt,firstnumber=last#1}\needlines{#2}}{}

\newcommand{\lst}[1]{{\tt #1}}

% Use this only in special situations where \ct does not work
% (within Section headings ...):
\newcommand{\lct}[1]{{\textsf{\textup{#1}}}}
% Code environments
\lstnewenvironment{code}{%
	\lstset{%
		% frame=lines,
		frame=single,
		framerule=0pt,
		mathescape=false
	}
}{}

\renewcommand{\lstlistingname}{Code Example}

% =============================================================================
\newboolean{showcomments}
\setboolean{showcomments}{true}

% define review shortcuts, once...
\ifthenelse{\boolean{showcomments}} {
	%... enabled (showcomments == true) ...
	\newcommand{\ugh}[1] {\textcolor{red}{\uwave{#1}}}	% please rephrase
	\newcommand{\ins}[1] {\textcolor{blue}{\uline{#1}}}	% please insert
	\newcommand{\del}[1] {\textcolor{red}{\sout{#1}}}	% please delete
	\newcommand{\chg}[2] {								% please change
		\textcolor{red}{\sout{#1}}{\ra}
		\textcolor{blue}{\uline{#2}}}
	\newcommand{\nbc}[3]{								% comment
		{\colorbox{#3}{\bfseries\sffamily\scriptsize\textcolor{white}{#1}}}
		{\textcolor{#3}{\sf\small$\blacktriangleright$\textit{#2}$\blacktriangleleft$}}}

}{
	%... and once disbled (showcomments == false)
	\newcommand{\ugh}[1]{#1}							% please rephrase
	\newcommand{\ins}[1]{#1}							% please insert
	\newcommand{\del}[1]{}								% please delete
	\newcommand{\chg}[2]{#2}							% please change
	\newcommand{\nbc}[3]{}								% comment
}

% =============================================================================
\usepackage[pagebackref,hyperindex=true]{hyperref}

% Links in pdf
\definecolor{linkcol}{rgb}{0.0, 0.0, 0.0} 
\definecolor{citecol}{rgb}{0.0, 0.0, 0.0} 

% Change this to change the informations included in the pdf file
% See hyperref documentation for information on those parameters
\hypersetup {
	bookmarksopen=true,
	pdftitle=\thesistitle,
	pdfauthor=\thesisauthor, 
	pdfsubject="", %subject of the document
	pdfhighlight=/O, %effect of clicking on a link
	colorlinks=false,
	pdfpagemode=UseNone,
	pdfpagelayout=SinglePage,
	pdffitwindow=true,
	linkcolor=linkcol,
	citecolor=citecol,
	urlcolor=linkcol
}

% =============================================================================
\newcommand{\figlabel}[1] {\label{fig:#1}}
\newcommand{\chaplabel}[1]{\label{chap:#1}}
\newcommand{\seclabel}[1] {\label{sec:#1}}
\newcommand{\tablabel}[1] {\label{tab:#1}}
\newcommand{\lstlabel}[1] {\label{lst:#1}}

\newcommand{\figref}[1] {\hyperref[fig:#1]{Figure}~\ref{fig:#1}}
\newcommand{\chapref}[1]{\hyperref[chap:#1]{Chapter}~\ref{chap:#1}}
\newcommand{\secref}[1] {\hyperref[sec:#1]{Section}~\ref{sec:#1}}
\newcommand{\tabref}[1] {\hyperref[tab:#1]{Table}~\ref{tab:#1}}
\newcommand{\lstref}[1] {\hyperref[lst:#1]{Listing}~\ref{lst:#1}}

\newcommand{\urlfootnote}[2] {\href{#2}{#1}\footnote{\url{#2}}}

\newcommand{\commented}[1]{}

% custom Introduction section, slightly pushed left to visually align with the following paragraph
\newcommand{\introduction}{\section*{\hspace{-1pt}Introduction}} 

\newcommand{\bs}    {\symbol{'134}} % backslash
\newcommand{\us}    {\symbol{'137}} % underscore
\newcommand{\ttt}[1]{\texttt{#1}}
\newcommand{\ie}    {\emph{i.e.},\xspace}
\newcommand{\eg}    {\emph{e.g.},\xspace}
\newcommand{\etal}  {\emph{et al.}\xspace}
\newcommand{\ns}    {\!\!\!\!} %big negative space
\newcommand{\cnull} {\textbackslash0\xspace}
\renewcommand{\epsilon}{\varepsilon}


\newcommand{\nb}[2]{\nbc{#1}{#2}{orange}}
\newcommand\fix[1] {\nb{FIX}{#1}}
\newcommand\todo[1]{\nb{TO DO}{#1}}
\newcommand\cb[1]  {\nbc{CB}{#1}{purple}}
\newcommand\sd[1]  {\nbc{SD}{#1}{orange}}
\newcommand\is[1]  {\nbc{IS}{#1}{gray}}
\newcommand\gc[1]  {\nbc{GC}{#1}{olive}}
\newcommand\ct[1]  {\nbc{CT}{#1}{teal}}
\newcommand\md[1]  {\nbc{MD}{#1}{blue}}
\newcommand\dc[1]  {\nbc{DC}{#1}{green}}

% italic quotes
\let\oldquote\quote
\let\oldendquote\endquote
\renewenvironment{quote}
	{\oldquote\itshape}
	{\oldendquote}
	
% =============================================================================
\hyphenation{tool-chain pipe-line lan-guage lan-guage-side}

% =============================================================================
\newcommand{\API}	{\textsc{api}\xspace}
\newcommand{\ARM}	{\textsc{arm}\xspace}
\newcommand{\AST}	{\textsc{ast}\xspace}
\newcommand{\ASM}	{\textsc{asm}\xspace}
\newcommand{\AsmJIT}{\textsc{AsmJit}\xspace}
\newcommand{\Alien}	{\textsc{Alien}\xspace}
\newcommand{\B}		{\textsc{Benzo}\xspace}
\newcommand{\CPU}	{\textsc{cpu}\xspace}
\newcommand{\Cog}	{\textsc{Cog}\xspace}
\newcommand{\DTrace}	{\textsc{DTrace}\xspace}
\newcommand{\FFIs}	{\textsc{ffi}s\xspace}
\newcommand{\FFI}	{\textsc{ffi}\xspace}
\newcommand{\GC}	{\textsc{gc}\xspace}
\newcommand{\GCC}	{\textsc{gcc}\xspace}
\newcommand{\GDB}	{\textsc{gdb}\xspace}
\newcommand{\INRIA}	{\textsc{inria}\xspace}
\newcommand{\IR}	{\textsc{ir}\xspace}
\newcommand{\JIT}	{\textsc{jit}\xspace}
\newcommand{\Java}	{\textsc{Java}\xspace}
\newcommand{\Jikes}	{\textsc{Jikes}\xspace}
\newcommand{\Klein}	{\textsc{Klein}\xspace}
\newcommand{\Linux}	{\textsc{Linux}\xspace}
\newcommand{\LLDB}	{\textsc{lldb}\xspace}
\newcommand{\LuaJIT}{\Luajit}
\newcommand{\Luajit}{\textsc{Luajit}\xspace}
\newcommand{\Lua}	{\textsc{Lua}\xspace}
\newcommand{\Mate}	{\textsc{Mate}\xspace}
\newcommand{\MOP}	{\textsc{mop}\xspace}
\newcommand{\NBFFI}	{\textsc{Native\-Boost-ffi}\xspace}
\newcommand{\NBJ}	{\textsc{Nabujito}\xspace}
\newcommand{\NB}	{\textsc{Native\-Boost}\xspace}
\newcommand{\Nabujito}	{\NBJ\xspace}
\newcommand{\OS}	{\textsc{os}\xspace}
\newcommand{\PH}	{\textsc{Pharo}\xspace}
\newcommand{\Pinocchio}		{\textsc{Pinocchio}\xspace}
\newcommand{\ptrace}		{\textsc{ptrace}\xspace}
\renewcommand{\P}	{\Pinocchio}
\newcommand{\PyPy}	{\textsc{PyPy}\xspace}
\newcommand{\Python}{\textsc{Python}\xspace}
\newcommand{\RMoD}	{\textsc{rmod}\xspace}
\newcommand{\SCG}	{\textsc{scg}\xspace}
\newcommand{\SSA}	{\textsc{ssa}\xspace}
\newcommand{\ST}	{\textsc{Small\-talk}\xspace}
\newcommand{\Self}	{\textsc{Self}\xspace}
\newcommand{\Slang} {\textsc{Slang}\xspace}
\newcommand{\Squeak} {\textsc{Squeak}\xspace}
\newcommand{\TAC}	{\textsc{tac}\xspace}
\newcommand{\UBA}	{\textsc{uba}\xspace}
\newcommand{\unix}	{\textsc{unix}\xspace}
\newcommand{\VCPU}	{\textsc{VirtualCpu}\xspace}
\newcommand{\VirtualCPU}	{\VCPU}
\newcommand{\Windows}	{\textsc{Windows}\xspace}
\newcommand{\VMs}	{\textsc{vm}s\xspace}
\newcommand{\VM}	{\textsc{vm}\xspace}
\newcommand{\WF}	{\textsc{Waterfall}\xspace}
\newcommand{\x}	{\textsc{x}\xspace}
